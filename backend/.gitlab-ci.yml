stages: [build, notify]

build-backend-code-job:
  stage: build
  tags: [gitlab_runner_1]
  only:
    changes: [backend/**/*]
  script:
    - cd backend
    - mvn -B -DskipTests package
  artifacts:
    name: "backend-$CI_COMMIT_SHORT_SHA"
    paths:
      - backend/target/*.jar        # ← путь как в методичке
    expire_in: 1 week
    when: always

telegram-notification-backend:
  stage: notify
  tags: [gitlab_runner_1]
  needs: [build-backend-code-job]
  only:
    changes: [backend/**/*]
    variables:
      - $CI_COMMIT_MESSAGE =~ /send notification/i
  script: |
    ARTIFACT_URL="$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_SHA/download?job=build-backend-code-job"
    MSG="✅ *Backend build success*\nProject: *$CI_PROJECT_PATH*\nBranch: *$CI_COMMIT_REF_NAME*\nCommit: \`$CI_COMMIT_SHORT_SHA\`\nArtifacts: $ARTIFACT_URL"
    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
      -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode=Markdown \
      --data-urlencode text="$MSG"
